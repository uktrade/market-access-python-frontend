{% extends 'base.html' %}

{% load static %}

{% block page_title %}{{ block.super }} - Find a barrier{% endblock %}

{% block body_script %}
    <!-- build:js(src) /public/js/vue.min.js -->
    <script src="{% static 'js/vue/vue-bundle.js' %}"></script>
    <!-- endbuild -->
{% endblock %}

{% block page_content %}

    {% include 'heading.html' with caption='Market access barriers' text='Find a barrier' %}

    <section class="govuk-grid-row">
        <div class="govuk-grid-column-one-quarter">
            <h2 class="filter-list-title">Filter barriers by:</h2>
            <form action="" method="GET" class="filter-items">

                {% if form.edit.value %}{{ form.edit }}{% endif %}

                <div id="{{ form.search.name }}" class="govuk-form-group filter-items-group">
                    <label class="govuk-label filter-items__label" for="search">
                      {{ form.search.label }}
                    </label>

                    <input class="govuk-input" name="search" type="text" value="{% if form.search.value %}{{ form.search.value }}{% endif %}">
                </div>

                {% include 'partials/typeahead.html' with placeholder='Search locations' field=form.country %}
                {% include 'partials/typeahead.html' with placeholder='Search sector' field=form.sector %}
                {% include 'partials/typeahead.html' with placeholder='Search type' field=form.type %}
                {% include 'partials/typeahead.html' with placeholder='Search regions' field=form.region extra_classes='js-filter' %}
                {% include 'partials/checkbox_filter.html' with field=form.priority extra_classes='barrier-priority-filter' %}
                {% include 'partials/checkbox_filter.html' with field=form.status %}
                {% include 'partials/checkbox_filter.html' with field=form.created_by %}

                {% if filters %}
                <a class="filter-items__clear" href="{% url 'barriers:find_a_barrier' %}">Remove all filters</a>
                {% endif %}

                <input type="submit" value="Apply filters" class="govuk-button govuk-button--full-width js-filter-submit">
            </form>
        </div>
        <div class="govuk-grid-column-three-quarters">

            <div class="filter-results-header">
                <h2 class="filter-results-title">{{ barriers|length }}<span class="filter-results-title__caption"> barrier{{ barriers|length|pluralize }}</span></h2>

                {% if filters %}
                    <h3 class="visually-hidden">Active filters:</h3>
                    <ul class="active-filters">
                        {% include 'barriers/active_filter.html' with filter=filters.search %}
                        {% include 'barriers/active_filter.html' with filter=filters.country %}
                        {% include 'barriers/active_filter.html' with filter=filters.sector %}
                        {% include 'barriers/active_filter.html' with filter=filters.type %}
                        {% include 'barriers/active_filter.html' with filter=filters.region %}
                        {% include 'barriers/active_filter.html' with filter=filters.priority %}
                        {% include 'barriers/active_filter.html' with filter=filters.status %}
                        {% include 'barriers/active_filter.html' with filter=filters.created_by %}
                    </ul>

                    <div class="filter-results-action-buttons{% if not editWatchList %} filter-results-action-buttons--save{% endif %}">
                        <a class="filter-results-clear-link" href="{% url 'barriers:find_a_barrier' %}{% if request.GET.edit %}?edit={{ request.GET.edit }}{% endif %}">Remove all filters</a>
                        {% if form.edit.value is not None %}
                            {% if have_filters_changed %}
                            <a href="{% url 'barriers:edit_watchlist' %}?{{ request.GET.urlencode }}" class="govuk-button govuk-button--watch-list">Edit watch list</a>
                            {% endif %}
                        {% elif filters %}
                            <a href="{% url 'barriers:save_watchlist' %}?{{ request.GET.urlencode }}" class="govuk-button govuk-button--watch-list">Save watch list</a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            {% if paginationData.totalPages > 1 %}
            <p class="filter-results-pagination-summary">
                Page {{ paginationData.currentPage }} of {{ paginationData.totalPages }}
            </p>
            {% endif %}

            <p class="filter-results-download">
                {% if barriers|length %}
                    <span class="filter-results-download__text">
                    {% if barriers|length == 1 %}
                        You can download this barrier
                    {% else %}
                        You can download these {{ barriers|length }} barriers
                    {% endif %}
                    </span>
                    <a class="govuk-button filter-results-download__button" href="{% url 'barriers:download' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}">Download</a>
                {% else %}
                    <span class="filter-results-download__text">There are no barriers to download</span>
                {% endif %}
            </p>

            <ol class="filter-results-list">
                {% for barrier in barriers %}
                    <li class='filter-results-list__item'>
                        <div class="filter-results-list__item__main-content">
                            <h3 class='filter-results-list__item__heading'><a href="{% url 'barriers:barrier_detail' barrier.id %}">{{ barrier.title }}</a></h3>
                            <dl class="filter-results-list__item__definitions">

                                <dt class="filter-results-list__item__definitions__key visually-hidden">ID:</dt>
                                <dd class="filter-results-list__item__definitions__value">{{ barrier.code }}</dd>

                                <dt class="filter-results-list__item__definitions__key">Added:</dt>

                                <dd class="filter-results-list__item__definitions__value">{{ barrier.date.reported|date:"j F Y" }}</dd>

                                {% if barrier.sectors|length %}
                                <dt class="filter-results-list__item__definitions__key">Sector{{ barrier.sectors|pluralize }} affected:</dt>
                                <dd class="filter-results-list__item__definitions__value">{{ barrier.sector_names|join:', ' }}</dd>
                                {% endif %}

                                <dt class="filter-results-list__item__definitions__key">Barrier location:</dt>
                                <dd class="filter-results-list__item__definitions__value">{{ barrier.location }}</dd>
                            </dl>
                        </div>

                        <ul class="filter-results-list__item__sub-content">
                            <li class="filter-results-list__item__sub-content__item">
                                <span class="barrier-status-badge barrier-status-badge--compact barrier-status-badge--{{ barrier.status.modifier }}">
                                    <strong>{{ barrier.status.name }}</strong>
                                </span>
                            </li>
                            <li class="filter-results-list__item__sub-content__item">
                                <span class="priority-marker-wrapper">
                                    <span class="priority-marker priority-marker--{{ barrier.priority.code|lower }}"></span><strong>{{ barrier.priority.name }}</strong> priority
                                </span>
                            </li>
                        </ul>
                    </li>
                {% endfor %}
            </ol>


        </div>
    </section>

{% endblock %}
